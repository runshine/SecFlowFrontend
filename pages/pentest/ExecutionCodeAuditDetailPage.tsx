import React, { useState, useEffect, useRef } from 'react';
import { 
  ChevronLeft, 
  ExternalLink, 
  RefreshCw, 
  Loader2, 
  Terminal, 
  Database, 
  Activity, 
  ShieldCheck, 
  Box, 
  Network, 
  Cpu, 
  HardDrive, 
  Clock, 
  X, 
  Trash2, 
  ArrowUpRight, 
  Lock, 
  Eye, 
  EyeOff, 
  Key, 
  FileCode,
  AlertTriangle,
  Info,
  Calendar,
  CheckCircle2,
  Server,
  Copy,
  Check
} from 'lucide-react';
import { api } from '../../api/api';
import { StatusBadge } from '../../components/StatusBadge';

interface ExecutionCodeAuditDetailPageProps {
  projectId: string;
  instanceName: string;
  onBack: () => void;
}

const CredentialItem: React.FC<{ label: string; value?: string }> = ({ label, value }) => {
  const [copied, setCopied] = useState(false);
  const [isVisible, setIsVisible] = useState(false);

  const handleCopy = () => {
    if (!value) return;
    navigator.clipboard.writeText(value);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  if (!value) return null;

  return (
    <div className="flex flex-col gap-1.5">
      <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">{label}</span>
      <div className="bg-slate-50 border border-slate-100 p-4 rounded-2xl flex items-center justify-between group relative overflow-hidden">
        <div className="flex items-center gap-3 min-w-0">
          <Key size={14} className="text-slate-300 shrink-0" />
          <span className="text-sm font-mono font-black text-slate-700 truncate">
            {isVisible ? value : '••••••••••••••••'}
          </span>
        </div>
        <div className="flex items-center gap-2 shrink-0">
           <button 
             onClick={() => setIsVisible(!isVisible)} 
             className="p-2 text-slate-300 hover:text-blue-600 transition-colors"
             title={isVisible ? "Hide Password" : "Show Password"}
           >
             {isVisible ? <EyeOff size={16} /> : <Eye size={16} />}
           </button>
           <button 
             onClick={handleCopy} 
             className={`p-2 rounded-xl transition-all ${copied ? 'bg-green-50 text-white shadow-lg' : 'text-slate-300 hover:text-blue-600'}`}
             title="Copy to Clipboard"
           >
             {copied ? <Check size={16} /> : <Copy size={16} />}
           </button>
        </div>
        {copied && (
          <div className="absolute top-0 right-0 h-full w-2 bg-green-500 animate-in fade-in slide-in-from-right-1" />
        )}
      </div>
    </div>
  );
};

export const ExecutionCodeAuditDetailPage: React.FC<ExecutionCodeAuditDetailPageProps> = ({ projectId, instanceName, onBack }) => {
  const [loading, setLoading] = useState(true);
  const [instance, setInstance] = useState<any>(null);
  const [k8sStatus, setK8sStatus] = useState<any>(null);
  const [logs, setLogs] = useState<string>('');
  const [isRefreshingLogs, setIsRefreshingLogs] = useState(false);
  const [tailLines, setTailLines] = useState(100);
  const logEndRef = useRef<HTMLDivElement>(null);

  // Confirmation Modals State
  const [showRebuildConfirm, setShowRebuildConfirm] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [isActionProcessing, setIsActionProcessing] = useState(false);

  useEffect(() => {
    loadAll();
    const interval = setInterval(loadRuntimeInfo, 5000); // Increased frequency for real-time tracking
    return () => clearInterval(interval);
  }, [projectId, instanceName]);

  const loadAll = async () => {
    setLoading(true);
    try {
      await Promise.all([
        loadDetail(),
        loadRuntimeInfo(),
        loadLogs()
      ]);
    } finally {
      setLoading(false);
    }
  };

  const loadDetail = async () => {
    const res = await api.codeServer.getDetail(projectId, instanceName);
    setInstance(res);
  };

  const loadRuntimeInfo = async () => {
    const res = await api.codeServer.getStatus(projectId, instanceName);
    setK8sStatus(res);
  };

  const loadLogs = async () => {
    setIsRefreshingLogs(true);
    try {
      const res = await api.codeServer.getLogs(projectId, instanceName, tailLines);
      setLogs(res.logs || '');
      setTimeout(() => logEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
    } finally {
      setIsRefreshingLogs(false);
    }
  };

  const handleRestart = async () => {
    setIsActionProcessing(true);
    try {
      await api.codeServer.restart(projectId, instanceName);
      setShowRebuildConfirm(false);
      alert("重建任务已提交");
      onBack();
    } catch (err: any) {
      alert("重建失败: " + err.message);
    } finally {
      setIsActionProcessing(false);
    }
  };

  const handleDelete = async () => {
    setIsActionProcessing(true);
    try {
      await api.codeServer.delete(projectId, instanceName);
      setShowDeleteConfirm(false);
      alert("删除任务已提交");
      onBack();
    } catch (err: any) {
      alert("删除失败: " + err.message);
    } finally {
      setIsActionProcessing(false);
    }
  };

  if (loading && !instance) {
    return (
      <div className="h-full flex flex-col items-center justify-center p-20 animate-in fade-in">
        <Loader2 className="animate-spin text-blue-600 mb-6" size={48} />
        <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">正在建立与 K8S 集群的审计会话...</p>
      </div>
    );
  }

  // Combined status logic
  const currentStatus = k8sStatus?.status || instance?.status || 'Unknown';
  const podStatus = k8sStatus?.pod_status;
  const isPending = podStatus?.toLowerCase() === 'pending';

  return (
    <div className="p-10 space-y-8 animate-in slide-in-from-right duration-500 pb-24 h-full overflow-y-auto custom-scrollbar">
      {/* Detail Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 bg-white/50 backdrop-blur-md p-8 rounded-[3rem] border border-white shadow-sm">
        <div className="flex items-center gap-8">
          <button 
            onClick={onBack}
            className="p-5 bg-white border border-slate-200 rounded-[1.5rem] hover:bg-slate-50 transition-all shadow-sm group active:scale-95"
          >
            <ChevronLeft size={24} className="group-hover:-translate-x-1 transition-transform" />
          </button>
          <div>
            <div className="flex items-center gap-4">
              <h2 className="text-4xl font-black text-slate-800 tracking-tight">{instanceName}</h2>
              <div className="flex items-center gap-2">
                 <StatusBadge status={currentStatus} />
                 {podStatus && podStatus !== 'Running' && (
                    <span className={`text-[9px] font-black px-2 py-0.5 rounded-lg border uppercase animate-pulse ${
                      isPending ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-slate-50 text-slate-400 border-slate-100'
                    }`}>
                       POD: {podStatus}
                    </span>
                 )}
              </div>
            </div>
            <div className="flex items-center gap-6 mt-3">
               <div className="flex items-center gap-2 text-slate-400 font-bold text-xs uppercase tracking-widest">
                 <Box size={14} /> ID: <span className="text-slate-600 font-mono">{(k8sStatus?.id || instance?.id)?.slice(0, 8)}</span>
               </div>
               <div className="w-1.5 h-1.5 bg-slate-200 rounded-full" />
               <div className="flex items-center gap-2 text-slate-400 font-bold text-xs uppercase tracking-widest">
                 <Calendar size={14} /> 启动于: <span className="text-slate-600">{instance?.created_at?.replace('T', ' ') || 'N/A'}</span>
               </div>
            </div>
          </div>
        </div>

        <div className="flex gap-4 self-end md:self-center">
          {instance?.access_url && currentStatus === 'running' && (
            <a 
              href={instance.access_url} 
              target="_blank" 
              rel="noreferrer"
              className="px-8 py-4 bg-blue-600 text-white rounded-[1.5rem] font-black hover:bg-blue-700 transition-all flex items-center gap-3 shadow-xl shadow-blue-500/20 active:scale-95"
            >
              打开编辑器 <ArrowUpRight size={20} />
            </a>
          )}
          
          <button 
            onClick={loadAll}
            className="p-5 bg-white border border-slate-200 text-slate-500 rounded-[1.5rem] hover:bg-slate-50 transition-all shadow-sm active:scale-95 group"
            title="手动刷新详情与日志"
          >
            <RefreshCw size={20} className={loading ? 'animate-spin' : 'group-hover:rotate-180 transition-transform duration-500'} />
          </button>

          <button 
            onClick={() => setShowRebuildConfirm(true)}
            disabled={isPending}
            className={`px-8 py-4 rounded-[1.5rem] font-black transition-all flex items-center gap-3 active:scale-95 ${
              isPending 
                ? 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed opacity-60' 
                : 'bg-amber-50 text-amber-600 border border-amber-100 hover:bg-amber-600 hover:text-white'
            }`}
            title={isPending ? "POD 正在启动中，暂无法执行重建操作" : "彻底重建环境"}
          >
            <RefreshCw size={20} /> 重建环境
          </button>

          <button 
            onClick={() => setShowDeleteConfirm(true)}
            className="px-8 py-4 bg-red-600 text-white rounded-[1.5rem] font-black hover:bg-red-700 transition-all flex items-center gap-3 shadow-xl shadow-blue-500/20 active:scale-95"
          >
            <Trash2 size={20} /> 销毁实例
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* Left Column: Metrics and Configuration */}
        <div className="lg:col-span-4 space-y-8">
           {/* Real-time Status Card */}
           <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm space-y-8">
              <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                <Activity size={16} className="text-blue-500" /> K8S 运行时遥感
              </h4>
              
              <div className="space-y-5">
                 <div className="flex justify-between items-center">
                    <span className="text-xs font-bold text-slate-500 uppercase">POD IP 地址</span>
                    <span className={`text-sm font-mono font-black ${k8sStatus?.pod_ip ? 'text-blue-600' : 'text-slate-300'}`}>
                       {k8sStatus?.pod_ip || 'Waiting for allocation...'}
                    </span>
                 </div>
                 <div className="flex justify-between items-center">
                    <span className="text-xs font-bold text-slate-500 uppercase">承载物理节点</span>
                    <span className={`text-xs font-black ${k8sStatus?.node_name ? 'text-slate-700' : 'text-slate-300'}`}>
                       {k8sStatus?.node_name || 'Scheduling...'}
                    </span>
                 </div>
                 <div className="flex justify-between items-center">
                    <span className="text-xs font-bold text-slate-500 uppercase">副本就绪状态</span>
                    <div className="flex items-center gap-2">
                       <div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                          <div 
                             className="h-full bg-blue-500 transition-all duration-500" 
                             style={{ width: `${(k8sStatus?.ready_replicas / k8sStatus?.total_replicas) * 100 || 0}%` }} 
                          />
                       </div>
                       <span className="text-xs font-black text-slate-700">
                          {k8sStatus?.ready_replicas ?? 0} / {k8sStatus?.total_replicas ?? 1}
                       </span>
                    </div>
                 </div>
                 <div className="flex justify-between items-center">
                    <span className="text-xs font-bold text-slate-500 uppercase">命名空间</span>
                    <span className="text-xs font-black text-slate-400 uppercase tracking-tighter">
                       {k8sStatus?.namespace || instance?.namespace}
                    </span>
                 </div>
              </div>

              <div className="pt-8 border-t border-slate-100 flex items-center gap-4">
                 <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${currentStatus === 'running' ? 'bg-green-50 text-green-500' : 'bg-slate-50 text-slate-300'}`}>
                    <CheckCircle2 size={24} />
                 </div>
                 <div>
                    <p className="text-xs font-black text-slate-800">
                       {currentStatus === 'running' ? '服务已就绪' : '正在编排服务...'}
                    </p>
                    <p className="text-[10px] text-slate-400 font-medium">
                       {currentStatus === 'running' ? '外部 Ingress 已完成安全证书握手' : '等待 K8S 控制平面分发负载'}
                    </p>
                 </div>
              </div>
           </div>

           {/* Persistence Info */}
           <div className="bg-slate-900 p-8 rounded-[2.5rem] text-white space-y-6 shadow-2xl relative overflow-hidden group">
              <Database className="absolute right-[-10px] top-[-10px] w-32 h-32 opacity-5 rotate-12 group-hover:rotate-0 transition-transform duration-700" />
              <h4 className="text-[11px] font-black text-slate-500 uppercase tracking-[0.2em] relative z-10">持久化存储卷映射</h4>
              
              <div className="space-y-4 relative z-10">
                 <div>
                    <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2">Source PVC (Read-only)</p>
                    {instance?.source_pvcs?.map((pvc: any, i: number) => (
                      <div key={i} className="bg-white/5 border border-white/5 p-4 rounded-2xl flex items-center gap-3">
                         <FileCode size={18} className="text-blue-400" />
                         <div className="min-w-0">
                            <p className="text-xs font-black truncate">{pvc.pvc_name}</p>
                            <p className="text-[9px] font-mono text-slate-400 uppercase">Mount: {pvc.mount_path}</p>
                         </div>
                      </div>
                    ))}
                    {(!instance?.source_pvcs || instance.source_pvcs.length === 0) && (
                       <p className="text-[10px] text-slate-600 italic ml-1">No source code volumes attached</p>
                    )}
                 </div>

                 {instance?.output_pvcs?.length > 0 && (
                   <div>
                      <p className="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2">Result PVC (Read-Write)</p>
                      {instance.output_pvcs.map((pvc: any, i: number) => (
                        <div key={i} className="bg-white/5 border border-white/5 p-4 rounded-2xl flex items-center gap-3">
                           <HardDrive size={18} className="text-indigo-400" />
                           <div className="min-w-0">
                              <p className="text-xs font-black truncate">{pvc.pvc_name}</p>
                              <p className="text-[9px] font-mono text-slate-400 uppercase">Size: {pvc.storage_size} | Path: {pvc.mount_path}</p>
                           </div>
                        </div>
                      ))}
                   </div>
                 )}
              </div>
           </div>

           {/* Access Credentials */}
           <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm space-y-6">
              <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                <Lock size={16} className="text-amber-500" /> 安全访问凭证
              </h4>
              
              <div className="space-y-4">
                 <CredentialItem label="WEB ACCESS PASSWORD" value={instance?.code_server_env?.PASSWORD} />
                 <CredentialItem label="SUDO AUTHORITY PASSWORD" value={instance?.code_server_env?.SUDO_PASSWORD} />
                 
                 <div className="p-4 bg-blue-50 border border-blue-100 rounded-2xl flex gap-3 mt-4">
                    <Info size={16} className="text-blue-600 shrink-0 mt-0.5" />
                    <p className="text-[10px] text-blue-600 leading-relaxed font-medium">
                       默认具备 SUDO权限，用户名固定为 <span className="font-bold">coder</span>。访问连接基于项目专属 Ingress 隧道分发。请妥善保管上述敏感凭证。
                    </p>
                 </div>
              </div>
           </div>
        </div>

        {/* Right Column: Live Logs */}
        <div className="lg:col-span-8 flex flex-col h-[800px] bg-[#0f172a] rounded-[3rem] shadow-2xl overflow-hidden border border-white/5">
           <div className="px-10 py-8 border-b border-white/5 flex items-center justify-between bg-white/5">
              <div className="flex items-center gap-4">
                 <div className="w-12 h-12 bg-blue-600 rounded-[1.25rem] flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
                    <Terminal size={24} />
                 </div>
                 <div>
                    <h3 className="text-xl font-black text-white tracking-wide">容器实例日志流</h3>
                    <p className="text-xs text-slate-500 font-bold uppercase tracking-widest mt-0.5 flex items-center gap-2">
                       <div className={`w-1.5 h-1.5 rounded-full ${currentStatus === 'running' ? 'bg-green-500 animate-pulse' : 'bg-slate-600'}`} />
                       Streaming from code-server container
                    </p>
                 </div>
              </div>
              <div className="flex items-center gap-4">
                 <select 
                    className="bg-white/5 border border-white/10 rounded-xl text-[10px] font-black text-slate-400 px-4 py-2.5 outline-none focus:ring-2 ring-blue-500/50 transition-all uppercase tracking-widest"
                    value={tailLines}
                    onChange={(e) => setTailLines(parseInt(e.target.value))}
                 >
                    <option value={100}>最近 100 行</option>
                    <option value={500}>最近 500 行</option>
                    <option value={1000}>最近 1000 行</option>
                 </select>
                 <button 
                    onClick={loadLogs}
                    disabled={isRefreshingLogs}
                    className="p-3.5 bg-blue-600 text-white rounded-xl hover:bg-blue-500 transition-all shadow-lg shadow-blue-500/10 disabled:opacity-50"
                 >
                    <RefreshCw size={18} className={isRefreshingLogs ? 'animate-spin' : ''} />
                 </button>
              </div>
           </div>

           <div className="flex-1 overflow-y-auto p-10 font-mono text-[11px] leading-relaxed custom-scrollbar bg-black/20">
              {logs ? (
                <div className="space-y-1">
                   {logs.split('\n').map((line, i) => (
                     <div key={i} className="flex gap-6 group hover:bg-white/5 px-2 -mx-2 transition-colors">
                        <span className="text-slate-700 w-8 shrink-0 text-right select-none opacity-50 group-hover:opacity-100">{i + 1}</span>
                        <span className={`break-all ${
                          line.toLowerCase().includes('error') ? 'text-red-400' : 
                          line.toLowerCase().includes('warn') ? 'text-amber-400' : 
                          'text-blue-100/80'
                        }`}>
                          {line || ' '}
                        </span>
                     </div>
                   ))}
                   <div ref={logEndRef} />
                </div>
              ) : (
                <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-20 uppercase font-black tracking-widest text-sm space-y-4">
                   <Terminal size={64} />
                   <p>{currentStatus === 'creating' ? '容器正在启动，等待日志流就绪...' : '等待日志输出缓冲区同步...'}</p>
                </div>
              )}
           </div>

           <div className="px-10 py-5 bg-white/5 border-t border-white/5 flex justify-between items-center">
              <div className="flex items-center gap-6">
                 <div className="flex items-center gap-2 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                    <div className={`w-1.5 h-1.5 rounded-full ${logs ? 'bg-green-500' : 'bg-slate-600'}`} />
                    BUFFER: {logs ? 'READY' : 'STANDBY'}
                 </div>
                 <div className="h-4 w-[1px] bg-white/10" />
                 <div className="text-[10px] font-black text-slate-500 uppercase">
                    Lines Scanned: {logs ? logs.split('\n').length : 0}
                 </div>
              </div>
              <button 
                onClick={() => setLogs('')}
                className="text-[10px] font-black text-slate-500 uppercase hover:text-white transition-colors"
              >
                Clear Screen
              </button>
           </div>
        </div>
      </div>

      {/* Confirmation Modals */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md animate-in fade-in">
          <div className="bg-white w-full max-w-md rounded-[3rem] shadow-2xl overflow-hidden animate-in zoom-in-95">
            <div className="p-10 text-center space-y-6">
              <div className="w-20 h-20 bg-red-50 text-red-600 rounded-3xl flex items-center justify-center mx-auto"><Trash2 size={40} /></div>
              <div>
                <h3 className="text-2xl font-black text-slate-800 tracking-tight">销毁审计实例？</h3>
                <p className="text-slate-500 mt-2 font-medium leading-relaxed italic">
                  您正准备永久删除环境 <span className="font-black text-slate-700">{instanceName}</span>，该操作将清空所有正在进行的审计会话且不可逆。
                </p>
              </div>
            </div>
            <div className="px-10 pb-10 flex gap-4">
              <button 
                onClick={() => setShowDeleteConfirm(false)} 
                disabled={isActionProcessing}
                className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black hover:bg-slate-200 transition-all"
              >
                保留实例
              </button>
              <button 
                onClick={handleDelete} 
                disabled={isActionProcessing} 
                className="flex-1 py-4 bg-red-600 text-white rounded-2xl font-black hover:bg-red-700 flex items-center justify-center gap-2 shadow-xl shadow-red-500/20 active:scale-95 transition-all"
              >
                {isActionProcessing ? <Loader2 size={18} className="animate-spin" /> : <Trash2 size={18} />} 
                确认销毁
              </button>
            </div>
          </div>
        </div>
      )}

      {showRebuildConfirm && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md animate-in fade-in">
          <div className="bg-white w-full max-w-md rounded-[3rem] shadow-2xl overflow-hidden animate-in zoom-in-95">
            <div className="p-10 text-center space-y-6">
              <div className="w-20 h-20 bg-amber-50 text-amber-600 rounded-3xl flex items-center justify-center mx-auto"><RefreshCw size={40} /></div>
              <div>
                <h3 className="text-2xl font-black text-slate-800 tracking-tight">确认重建环境？</h3>
                <div className="mt-4 p-4 bg-red-50 rounded-2xl border border-red-100">
                  <p className="text-red-500 text-xs font-bold leading-relaxed text-left flex gap-2">
                    <AlertTriangle size={16} className="shrink-0" />
                    <span>警告：重建将重置容器。除挂载的 PVC 卷外，内部文件和插件配置将全部丢失。</span>
                  </p>
                </div>
              </div>
            </div>
            <div className="px-10 pb-10 flex gap-4">
              <button 
                onClick={() => setShowRebuildConfirm(false)} 
                disabled={isActionProcessing}
                className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black hover:bg-slate-200 transition-all"
              >
                取消操作
              </button>
              <button 
                onClick={handleRestart} 
                disabled={isActionProcessing} 
                className="flex-1 py-4 bg-amber-600 text-white rounded-2xl font-black hover:bg-amber-700 flex items-center justify-center gap-2 shadow-xl shadow-amber-500/20 active:scale-95 transition-all"
              >
                {isActionProcessing ? <Loader2 size={18} className="animate-spin" /> : <RefreshCw size={18} />} 
                重启并重置
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
