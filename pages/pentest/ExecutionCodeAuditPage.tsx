
import React, { useState, useEffect, useMemo } from 'react';
import { 
  FileCode, 
  Terminal, 
  Bot, 
  RefreshCw, 
  Plus, 
  Loader2, 
  ExternalLink, 
  Trash2, 
  RotateCw, 
  Play, 
  ShieldCheck, 
  AlertTriangle, 
  Cpu, 
  Box, 
  Network, 
  Globe, 
  Database, 
  X,
  Layers,
  ChevronRight,
  Monitor,
  CheckCircle2,
  Lock,
  ArrowUpRight,
  Info
} from 'lucide-react';
import { api } from '../../api/api';
import { StatusBadge } from '../../components/StatusBadge';
import { ProjectPVC } from '../../types/types';

interface ExecutionCodeAuditPageProps {
  projectId: string;
}

export const ExecutionCodeAuditPage: React.FC<ExecutionCodeAuditPageProps> = ({ projectId }) => {
  const [loading, setLoading] = useState(true);
  const [instances, setInstances] = useState<any[]>([]);
  const [tasks, setTasks] = useState<any[]>([]);
  const [availablePvcs, setAvailablePvcs] = useState<ProjectPVC[]>([]);
  
  // Modals
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [createLoading, setCreateLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    source_pvc: '',
    password: 'secflow_audit',
  });

  useEffect(() => {
    if (projectId) {
      loadAll();
      const timer = setInterval(loadTasksAndStatus, 10000);
      return () => clearInterval(timer);
    }
  }, [projectId]);

  const loadAll = async () => {
    if (!projectId) return;
    setLoading(true);
    try {
      await Promise.all([
        loadInstances(),
        loadTasksAndStatus(),
        loadPvcs()
      ]);
    } catch (err) {
      console.error("Failed to load audit data", err);
    } finally {
      setLoading(false);
    }
  };

  const loadInstances = async () => {
    const res = await api.codeServer.list(projectId);
    setInstances(res.items || []);
  };

  const loadTasksAndStatus = async () => {
    const res = await api.codeServer.getTasks(projectId);
    setTasks(res.items || []);
    // Only refresh instance list to get status updates
    const instancesRes = await api.codeServer.list(projectId);
    setInstances(instancesRes.items || []);
  };

  const loadPvcs = async () => {
    const res = await api.resources.getPVCs(projectId);
    // CRITICAL: Filter PVCs that were uploaded as "code" type in Test Input section
    const codePvcs = (res.pvcs || []).filter(p => p.resource_type === 'code');
    setAvailablePvcs(codePvcs);
    
    // Auto-select the first one if only one exists
    if (codePvcs.length === 1 && !formData.source_pvc) {
      setFormData(prev => ({ ...prev, source_pvc: codePvcs[0].pvc_name }));
    }
  };

  const handleCreate = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.source_pvc) {
      alert("请选择源码 PVC");
      return;
    }
    setCreateLoading(true);
    try {
      await api.codeServer.create(projectId, {
        name: formData.name,
        namespace: projectId, // Use projectId as namespace context
        description: formData.description,
        source_pvcs: [{ pvc_name: formData.source_pvc, mount_path: '/home/coder/project' }],
        code_server_env: { PASSWORD: formData.password }
      });
      setIsCreateModalOpen(false);
      setFormData({ name: '', description: '', source_pvc: '', password: 'secflow_audit' });
      loadTasksAndStatus();
    } catch (err: any) {
      alert("创建失败: " + err.message);
    } finally {
      setCreateLoading(false);
    }
  };

  const handleDelete = async (name: string) => {
    if (!confirm(`确定要销毁实例 ${name} 吗？\n该操作将停止容器运行并删除访问入口。`)) return;
    try {
      await api.codeServer.delete(projectId, name);
      loadTasksAndStatus();
    } catch (err) {
      alert("删除请求提交失败");
    }
  };

  const handleRestart = async (name: string) => {
    try {
      await api.codeServer.restart(projectId, name);
      loadTasksAndStatus();
    } catch (err) {
      alert("重启请求提交失败");
    }
  };

  const activeInstancesCount = instances.filter(i => i.status === 'running').length;
  const pendingTasks = tasks.filter(t => t.status === 'pending' || t.status === 'running');

  return (
    <div className="p-10 space-y-10 animate-in fade-in duration-500 pb-24 h-full overflow-y-auto custom-scrollbar">
      {/* Page Header */}
      <div className="flex flex-col md:flex-row justify-between items-end gap-6">
        <div className="space-y-1">
          <div className="flex items-center gap-3">
             <div className="p-3 bg-blue-600 text-white rounded-[1.25rem] shadow-lg shadow-blue-500/20">
               <Bot size={28} />
             </div>
             <div>
               <h2 className="text-3xl font-black text-slate-800 tracking-tight">在线代码审计 (VSCode AI 版)</h2>
               <div className="flex items-center gap-2 mt-1">
                 <span className="text-xs bg-blue-100 text-blue-600 px-3 py-0.5 rounded-full font-black uppercase tracking-widest">K8S Orchestrated</span>
                 <span className="text-[10px] text-slate-400 font-bold uppercase">Current Project: {projectId || 'None'}</span>
               </div>
             </div>
          </div>
        </div>
        <div className="flex gap-4">
          <button 
            onClick={loadAll}
            className="p-4 bg-white border border-slate-200 text-slate-500 rounded-2xl hover:bg-slate-50 transition-all shadow-sm group active:scale-95"
          >
            <RefreshCw size={20} className={loading ? 'animate-spin' : 'group-hover:rotate-180 transition-transform duration-500'} />
          </button>
          <button 
            onClick={() => {
              loadPvcs();
              setIsCreateModalOpen(true);
            }}
            disabled={!projectId}
            className="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-3 shadow-xl shadow-blue-500/20 hover:bg-blue-700 transition-all active:scale-95 disabled:opacity-50"
          >
            <Plus size={20} /> 部署审计环境
          </button>
        </div>
      </div>

      {/* Analytics Row */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div className="bg-slate-900 p-8 rounded-[3rem] text-white shadow-2xl relative overflow-hidden group">
          <div className="absolute right-[-20px] top-[-20px] w-40 h-40 bg-blue-500 opacity-5 blur-3xl group-hover:opacity-10 transition-opacity" />
          <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest">活跃审计实例</p>
          <div className="flex items-end gap-3 mt-4">
             <h3 className="text-6xl font-black text-white">{activeInstancesCount}</h3>
             <div className="pb-2">
                <p className="text-xs font-black text-green-400 flex items-center gap-1 uppercase">
                  <Monitor size={12} /> Live
                </p>
             </div>
          </div>
          <div className="mt-8 pt-6 border-t border-white/5 flex justify-between items-center">
             <div className="space-y-1">
                <p className="text-[10px] font-black text-slate-500 uppercase">总实例数</p>
                <p className="text-xl font-black">{instances.length}</p>
             </div>
             <div className="w-10 h-10 bg-white/5 rounded-2xl flex items-center justify-center">
                <Layers className="text-blue-500" size={20} />
             </div>
          </div>
        </div>

        <div className="bg-white p-8 rounded-[3rem] border border-slate-200 shadow-sm flex flex-col justify-between">
           <div>
              <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest">待处理任务</p>
              <h3 className="text-4xl font-black mt-2 text-slate-800">{pendingTasks.length}</h3>
           </div>
           <div className="flex items-center gap-2 text-blue-500 text-[10px] font-black uppercase animate-pulse mt-4">
              <RotateCw size={12} className="animate-spin" /> Async Worker Syncing
           </div>
        </div>

        <div className="md:col-span-2 bg-white p-8 rounded-[3rem] border border-slate-200 shadow-sm overflow-hidden relative group">
           <Database className="absolute right-[-10px] bottom-[-10px] w-32 h-32 opacity-5 -rotate-12 group-hover:rotate-0 transition-transform" />
           <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-4">源码 PVC 资源现状</p>
           <div className="flex flex-wrap gap-2">
              {availablePvcs.slice(0, 8).map(pvc => (
                <div key={pvc.pvc_name} className="px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl flex items-center gap-2">
                  <FileCode size={12} className="text-blue-500" />
                  <span className="text-[10px] font-black text-slate-700">{pvc.pvc_name}</span>
                  <span className="text-[9px] font-bold text-slate-300">({pvc.capacity})</span>
                </div>
              ))}
              {availablePvcs.length === 0 && !loading && (
                <div className="flex items-center gap-2 text-amber-500 font-bold text-xs py-2 italic bg-amber-50 px-4 rounded-xl border border-amber-100">
                  <AlertTriangle size={14} /> 未发现源码 PVC，请先在「测试输入 -> 源代码」上传源码包。
                </div>
              )}
           </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="grid grid-cols-1 xl:grid-cols-12 gap-10 min-h-[500px]">
        
        {/* Instances List */}
        <div className="xl:col-span-8 space-y-6">
           <div className="flex items-center justify-between px-4">
              <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                <Box size={16} /> 审计实例控制台
              </h4>
           </div>

           {loading && instances.length === 0 ? (
             <div className="bg-white rounded-[3rem] border border-slate-200 p-20 text-center flex flex-col items-center">
                <Loader2 size={48} className="animate-spin text-blue-600 mb-6" />
                <p className="text-sm font-black text-slate-400 uppercase tracking-widest">同步集群实例状态...</p>
             </div>
           ) : instances.length > 0 ? (
             <div className="grid grid-cols-1 gap-6">
               {instances.map((item) => (
                 <div key={item.id} className="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm p-8 flex flex-col md:flex-row items-center gap-8 group hover:border-blue-300 transition-all">
                    <div className={`w-20 h-20 rounded-[2rem] flex items-center justify-center shrink-0 shadow-inner ${
                      item.status === 'running' ? 'bg-green-50 text-green-600' : 
                      item.status === 'error' ? 'bg-red-50 text-red-600' : 'bg-slate-50 text-slate-400'
                    }`}>
                       {item.status === 'running' ? <ShieldCheck size={40} /> : <FileCode size={40} />}
                    </div>
                    
                    <div className="flex-1 min-w-0 space-y-2">
                       <div className="flex items-center gap-3">
                          <h5 className="text-xl font-black text-slate-800">{item.name}</h5>
                          <StatusBadge status={item.status} />
                       </div>
                       <p className="text-xs text-slate-500 font-medium line-clamp-1 italic">"{item.description || '无描述'}"</p>
                       <div className="flex flex-wrap gap-4 pt-2">
                          <div className="flex items-center gap-1.5 text-[10px] font-black text-slate-400 uppercase">
                             <Database size={12} className="text-blue-500" /> PVC: {item.source_pvcs?.[0]?.pvc_name}
                          </div>
                          <div className="flex items-center gap-1.5 text-[10px] font-black text-slate-400 uppercase">
                             <Monitor size={12} className="text-indigo-500" /> Pod: {item.pod_name?.slice(-8)}
                          </div>
                          <div className="flex items-center gap-1.5 text-[10px] font-black text-slate-400 uppercase">
                             <Network size={12} className="text-amber-500" /> IP: {item.pod_ip || 'Unassigned'}
                          </div>
                       </div>
                    </div>

                    <div className="flex items-center gap-3 shrink-0">
                       {item.access_url && item.status === 'running' && (
                         <a 
                           href={item.access_url} 
                           target="_blank" 
                           rel="noreferrer"
                           className="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-xs flex items-center gap-2 hover:bg-blue-700 shadow-xl shadow-blue-500/20 transition-all active:scale-95"
                         >
                            打开 VSCode <ArrowUpRight size={14} />
                         </a>
                       )}
                       <button 
                         onClick={() => handleRestart(item.name)}
                         className="p-4 bg-slate-50 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-2xl transition-all"
                         title="重建实例"
                       >
                         <RefreshCw size={18} />
                       </button>
                       <button 
                         onClick={() => handleDelete(item.name)}
                         className="p-4 bg-slate-50 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-2xl transition-all"
                         title="销毁实例"
                       >
                         <Trash2 size={18} />
                       </button>
                    </div>
                 </div>
               ))}
             </div>
           ) : (
             <div className="bg-white rounded-[3rem] border border-slate-200 p-20 text-center flex flex-col items-center">
                <div className="w-20 h-20 bg-slate-50 text-slate-200 rounded-[2rem] flex items-center justify-center mb-6">
                   <Box size={40} />
                </div>
                <p className="text-sm font-black text-slate-400 uppercase tracking-widest">当前项目下暂无活跃的在线审计环境</p>
                <button 
                  onClick={() => setIsCreateModalOpen(true)}
                  disabled={!projectId}
                  className="mt-6 text-blue-600 font-black text-xs hover:underline uppercase disabled:opacity-50"
                >
                  立即部署第一个 VSCode 实例
                </button>
             </div>
           )}
        </div>

        {/* Task Activity Side Panel */}
        <div className="xl:col-span-4 space-y-6">
           <div className="flex items-center justify-between px-2">
              <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                <RotateCw size={14} /> 调度流水线
              </h4>
              <span className="text-[10px] font-black text-blue-500">{tasks.length} 历史记录</span>
           </div>

           <div className="bg-slate-900 rounded-[2.5rem] border border-white/5 shadow-2xl p-6 space-y-4">
              {tasks.length > 0 ? (
                tasks.slice(0, 6).map((task) => (
                  <div key={task.id} className="p-4 bg-white/5 border border-white/5 rounded-[1.5rem] space-y-3 hover:border-blue-500/30 transition-colors">
                     <div className="flex justify-between items-start">
                        <div className="flex items-center gap-3">
                           <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                             task.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                             task.status === 'failed' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'
                           }`}>
                              {task.type === 'create' ? <Plus size={16} /> : <Trash2 size={16} />}
                           </div>
                           <div className="min-w-0">
                              <p className="text-xs font-black text-white truncate">{task.code_server_name}</p>
                              <p className="text-[9px] font-bold text-slate-500 uppercase">{task.type} SESSION</p>
                           </div>
                        </div>
                        <StatusBadge status={task.status} />
                     </div>
                     {task.status === 'running' && (
                       <div className="h-1 bg-white/5 rounded-full overflow-hidden">
                          <div className="h-full bg-blue-500 animate-pulse w-2/3" />
                       </div>
                     )}
                     {task.error_message && (
                       <p className="text-[9px] text-red-400 font-medium bg-red-400/5 p-2 rounded-lg border border-red-400/10">
                         {task.error_message}
                       </p>
                     )}
                  </div>
                ))
              ) : (
                <div className="py-10 text-center text-slate-600 font-bold text-[10px] uppercase">
                   暂无调度记录
                </div>
              )}
              <button 
                onClick={loadTasksAndStatus}
                className="w-full py-3 bg-white/5 text-slate-500 text-[10px] font-black uppercase rounded-xl hover:bg-white/10 transition-all tracking-widest"
              >
                 刷新调度视图
              </button>
           </div>

           <div className="p-8 bg-blue-600/5 border border-blue-600/10 rounded-[2.5rem] space-y-4">
              <h5 className="text-[10px] font-black text-blue-600 uppercase tracking-widest flex items-center gap-2">
                 <Bot size={14} /> AI 审计助手就绪
              </h5>
              <p className="text-xs text-slate-600 leading-relaxed font-medium">
                部署后的 VSCode 已预装 <span className="font-bold text-blue-600">SecFlow-Auditor</span> 插件，支持自动化代码流分析与漏洞逻辑推演。
              </p>
           </div>
        </div>
      </div>

      {/* Deployment Modal */}
      {isCreateModalOpen && (
        <div className="fixed inset-0 z-[150] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-md animate-in fade-in">
           <div className="bg-white w-full max-w-xl rounded-[3rem] shadow-2xl overflow-hidden animate-in zoom-in-95">
              <div className="p-10 pb-6 border-b border-slate-50 bg-slate-50/30">
                 <div className="flex items-center gap-4">
                    <div className="w-14 h-14 bg-blue-600 text-white rounded-[1.5rem] flex items-center justify-center shadow-lg shadow-blue-500/20">
                       <FileCode size={28} />
                    </div>
                    <div>
                       <h3 className="text-2xl font-black text-slate-800 tracking-tight">部署审计实例</h3>
                       <p className="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">自动构建源码映射与安全沙箱入口</p>
                    </div>
                 </div>
              </div>

              <form onSubmit={handleCreate} className="p-10 space-y-6">
                 <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">实例标识名称 *</label>
                    <input 
                       required
                       placeholder="e.g. auth-service-review"
                       className="w-full px-6 py-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-4 ring-blue-500/10 font-bold text-slate-800 transition-all"
                       value={formData.name}
                       onChange={e => setFormData({...formData, name: e.target.value})}
                    />
                 </div>

                 <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 flex justify-between">
                      <span>挂载源码 PVC *</span>
                      <span className="text-blue-600 font-bold normal-case lowercase tracking-normal">来自项目：{projectId}</span>
                    </label>
                    {availablePvcs.length > 0 ? (
                      <select 
                         required
                         className="w-full px-6 py-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-4 ring-blue-500/10 font-bold text-slate-800 transition-all appearance-none"
                         value={formData.source_pvc}
                         onChange={e => setFormData({...formData, source_pvc: e.target.value})}
                      >
                         <option value="">选择已有源码存储卷...</option>
                         {availablePvcs.map(pvc => (
                           <option key={pvc.pvc_name} value={pvc.pvc_name}>{pvc.pvc_name} ({pvc.capacity})</option>
                         ))}
                      </select>
                    ) : (
                      <div className="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-700 font-bold flex flex-col gap-2">
                        <div className="flex items-center gap-2"><AlertTriangle size={14} /> 当前项目暂无源码 PVC。</div>
                        <div className="text-[10px] font-medium leading-relaxed opacity-80">请先在「测试输入 -> 源代码」页面上传并成功解压一个源代码包。</div>
                      </div>
                    )}
                 </div>

                 <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1.5">
                       <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">访问密码</label>
                       <div className="relative">
                          <Lock size={14} className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300" />
                          <input 
                             type="password"
                             className="w-full pl-12 pr-6 py-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-4 ring-blue-500/10 font-bold text-slate-800 transition-all"
                             value={formData.password}
                             onChange={e => setFormData({...formData, password: e.target.value})}
                          />
                       </div>
                    </div>
                    <div className="space-y-1.5">
                       <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">审计员 ID (PUID)</label>
                       <input 
                          type="number"
                          className="w-full px-6 py-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-4 ring-blue-500/10 font-bold text-slate-800 transition-all"
                          defaultValue={1000}
                       />
                    </div>
                 </div>

                 <div className="space-y-1.5">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">备注信息</label>
                    <textarea 
                       placeholder="描述该实例的审计目标..."
                       rows={2}
                       className="w-full px-6 py-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-4 ring-blue-500/10 font-bold text-slate-800 transition-all resize-none"
                       value={formData.description}
                       onChange={e => setFormData({...formData, description: e.target.value})}
                    />
                 </div>

                 <div className="pt-4 flex gap-4">
                    <button 
                       type="button"
                       onClick={() => setIsCreateModalOpen(false)}
                       className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black hover:bg-slate-200 transition-all active:scale-95"
                    >
                       取消
                    </button>
                    <button 
                       type="submit"
                       disabled={createLoading || availablePvcs.length === 0}
                       className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black hover:bg-blue-700 shadow-xl shadow-blue-500/20 transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50"
                    >
                       {createLoading ? <Loader2 size={20} className="animate-spin" /> : <Play size={20} />}
                       开始拉取并部署
                    </button>
                 </div>
              </form>
           </div>
        </div>
      )}
    </div>
  );
};
