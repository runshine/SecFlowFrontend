
import React, { useState } from 'react';
import { 
  FileCode, 
  FolderTree, 
  Terminal as TerminalIcon, 
  Bot, 
  Search, 
  Play, 
  Settings, 
  Layout, 
  ChevronRight, 
  Files, 
  Bug, 
  ShieldAlert,
  Save,
  Undo
} from 'lucide-react';

export const ExecutionCodeAuditPage: React.FC = () => {
  const [activeFile, setActiveFile] = useState('index.py');
  const [showTerminal, setShowTerminal] = useState(true);

  const files = [
    { name: 'main.py', type: 'python', status: 'safe' },
    { name: 'auth.py', type: 'python', status: 'warning' },
    { name: 'db_connector.py', type: 'python', status: 'error' },
    { name: 'config.yaml', type: 'yaml', status: 'safe' },
  ];

  const codeContent = `
import sqlite3
from flask import Flask, request

app = Flask(__name__)

@app.route("/user")
def get_user():
    user_id = request.args.get("id")
    conn = sqlite3.connect("users.db")
    cursor = conn.cursor()
    # ATTENTION: AI Detected potential SQL Injection vulnerability below
    query = "SELECT * FROM users WHERE id = '%s'" % user_id
    cursor.execute(query)
    return cursor.fetchone()

if __name__ == "__main__":
    app.run(debug=True)
  `;

  return (
    <div className="h-full flex flex-col bg-[#0d1117] text-slate-300 overflow-hidden font-mono animate-in fade-in">
      {/* Top IDE Bar */}
      <div className="h-10 bg-[#161b22] border-b border-white/5 flex items-center justify-between px-4 shrink-0">
        <div className="flex items-center gap-6">
           <div className="flex items-center gap-2">
             <Bot size={16} className="text-blue-400" />
             <span className="text-[10px] font-black uppercase tracking-widest text-white/50">SecFlow AI Code Insight</span>
           </div>
           <div className="flex items-center gap-1 text-[10px] font-bold">
             <span className="text-slate-500">Project:</span>
             <span className="text-blue-400">auth-service-v2</span>
           </div>
        </div>
        <div className="flex items-center gap-4">
           <button className="flex items-center gap-2 bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-black hover:bg-blue-500 transition-all">
             <Play size={12} /> RUN SCAN
           </button>
           <Settings size={14} className="text-slate-500 hover:text-white cursor-pointer" />
        </div>
      </div>

      <div className="flex-1 flex overflow-hidden">
        {/* Sidebar: Activity Bar */}
        <div className="w-12 bg-[#0d1117] border-r border-white/5 flex flex-col items-center py-4 gap-6 shrink-0">
           <Files size={20} className="text-white cursor-pointer" />
           <Search size={20} className="text-slate-600 hover:text-white cursor-pointer" />
           <Bug size={20} className="text-slate-600 hover:text-white cursor-pointer" />
           <ShieldAlert size={20} className="text-red-400 cursor-pointer" />
        </div>

        {/* Sidebar: File Explorer */}
        <div className="w-64 bg-[#161b22] border-r border-white/5 flex flex-col shrink-0">
           <div className="p-4 flex items-center justify-between">
              <span className="text-[10px] font-black uppercase text-slate-500 tracking-widest">Explorer</span>
           </div>
           <div className="px-2 space-y-1">
              {files.map(f => (
                <div 
                  key={f.name} 
                  onClick={() => setActiveFile(f.name)}
                  className={`flex items-center justify-between px-2 py-1.5 rounded-lg cursor-pointer transition-colors ${activeFile === f.name ? 'bg-blue-500/10 text-blue-400' : 'hover:bg-white/5'}`}
                >
                  <div className="flex items-center gap-2">
                    <FileCode size={14} className={activeFile === f.name ? 'text-blue-400' : 'text-slate-500'} />
                    <span className="text-xs font-bold">{f.name}</span>
                  </div>
                  {f.status === 'error' && <div className="w-1.5 h-1.5 bg-red-500 rounded-full" />}
                  {f.status === 'warning' && <div className="w-1.5 h-1.5 bg-amber-500 rounded-full" />}
                </div>
              ))}
           </div>
        </div>

        {/* Main Editor Area */}
        <div className="flex-1 flex flex-col overflow-hidden relative">
           {/* Tab Bar */}
           <div className="h-9 bg-[#161b22] flex items-center border-b border-white/5">
              <div className="px-4 h-full border-r border-white/5 bg-[#0d1117] flex items-center gap-2 text-xs font-bold text-white border-t-2 border-t-blue-500">
                 <FileCode size={14} className="text-blue-400" /> {activeFile}
              </div>
           </div>

           {/* Code Content */}
           <div className="flex-1 overflow-auto p-8 text-sm leading-relaxed relative group">
              <pre className="text-blue-100/80">
                {codeContent.split('\n').map((line, i) => (
                  <div key={i} className={`flex gap-8 ${line.includes('SQL Injection') ? 'bg-red-500/10 -mx-8 px-8 py-0.5 border-l-4 border-red-500' : ''}`}>
                    <span className="w-8 text-slate-700 text-right select-none">{i + 1}</span>
                    <span dangerouslySetInnerHTML={{ __html: line.replace(/# ATTENTION/, '<span class="text-red-400 font-black"># ATTENTION</span>') }} />
                  </div>
                ))}
              </pre>

              {/* AI Hover Annotation Placeholder */}
              <div className="absolute top-40 right-20 w-80 p-6 bg-[#161b22] border border-white/10 rounded-2xl shadow-2xl opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                 <div className="flex items-center gap-2 text-red-400 mb-2">
                    <ShieldAlert size={16} />
                    <span className="text-xs font-black uppercase">Critical Security Flaw</span>
                 </div>
                 <p className="text-[10px] leading-relaxed text-slate-400 font-medium">
                   Unsanitized input from <code className="bg-white/5 px-1 rounded text-blue-400">request.args.get</code> is directly used in a SQL query. 
                   Recommendation: Use parameterized queries.
                 </p>
              </div>
           </div>

           {/* Terminal Area */}
           {showTerminal && (
             <div className="h-48 bg-[#0d1117] border-t border-white/5 flex flex-col shrink-0">
                <div className="h-8 flex items-center justify-between px-4 border-b border-white/5 shrink-0">
                   <div className="flex items-center gap-4">
                      <span className="text-[10px] font-black uppercase text-blue-500 tracking-widest border-b border-blue-500 h-full flex items-center">Terminal</span>
                      <span className="text-[10px] font-black uppercase text-slate-600 tracking-widest cursor-pointer hover:text-slate-400">Output</span>
                   </div>
                   <X onClick={() => setShowTerminal(false)} size={14} className="text-slate-500 cursor-pointer" />
                </div>
                <div className="flex-1 p-4 font-mono text-[11px] text-green-400/80 overflow-auto">
                   <p className="mb-1 text-slate-500">secflow@agent-01:~/audit$ semgrep --config=p/security-audit .</p>
                   <p className="mb-1 text-red-400">ERROR: Found SQL Injection in auth.py:12</p>
                   <p className="mb-1">INFO: Scan completed in 1.4s. 1 critical, 2 medium findings.</p>
                   <div className="mt-2 flex items-center gap-1 animate-pulse">
                      <span className="text-blue-500">âžœ</span>
                      <span className="w-2 h-4 bg-slate-500" />
                   </div>
                </div>
             </div>
           )}
        </div>

        {/* Right Sidebar: AI Sidekick */}
        <div className="w-80 bg-[#161b22] border-l border-white/5 flex flex-col shrink-0">
           <div className="p-6 border-b border-white/5">
              <h4 className="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] mb-4">AI Sidekick</h4>
              <div className="p-4 bg-blue-500/5 border border-blue-500/10 rounded-2xl space-y-3">
                 <p className="text-xs leading-relaxed text-blue-100/80 font-medium italic">
                   "Hey Admin! I've detected a SQL injection in auth.py. Would you like me to generate a secure fix using SQLAlchemy ORM?"
                 </p>
                 <button className="w-full py-2 bg-blue-600 text-white rounded-xl text-[10px] font-black hover:bg-blue-500 transition-all">GENERATE FIX</button>
              </div>
           </div>
           <div className="flex-1 p-6 space-y-6 overflow-y-auto">
              <div className="space-y-2">
                 <p className="text-[10px] font-black uppercase text-slate-500 tracking-widest">Reasoning Log</p>
                 <div className="space-y-4">
                    <div className="flex gap-3">
                       <div className="w-1 h-1 rounded-full bg-blue-500 mt-1.5 shrink-0" />
                       <p className="text-[10px] leading-relaxed text-slate-400 font-medium">Tracing data flow from <code className="text-blue-400">request</code> input to sink.</p>
                    </div>
                    <div className="flex gap-3">
                       <div className="w-1 h-1 rounded-full bg-red-500 mt-1.5 shrink-0" />
                       <p className="text-[10px] leading-relaxed text-slate-400 font-medium">Sink <code className="text-red-400">cursor.execute</code> reached without sanitization.</p>
                    </div>
                 </div>
              </div>
           </div>
           <div className="p-4 border-t border-white/5">
              <input 
                placeholder="Ask AI anything about the code..." 
                className="w-full px-4 py-3 bg-[#0d1117] border border-white/10 rounded-xl text-xs outline-none focus:border-blue-500 transition-all"
              />
           </div>
        </div>
      </div>
    </div>
  );
};

const X = ({ size, onClick, className }: any) => (
  <svg 
    onClick={onClick}
    className={className}
    width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
  >
    <line x1="18" y1="6" x2="6" y2="18"></line>
    <line x1="6" y1="6" x2="18" y2="18"></line>
  </svg>
);
